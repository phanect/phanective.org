version: 2

jobs:
  build:
    working_directory: ~/phanective.org
    docker:
      - image: phanect/ci-javascript
    steps:
      - run:
          name: System Update
          command: |
            sudo apt-get update -qq
            DEBIAN_FRONTEND=noninteractive sudo apt-get dist-upgrade --yes
      - run:
          name: Configure git user
          command: |
            git config --global user.name "Jumpei Ogawa (via CircleCI)"
            git config --global user.email "phanect@users.noreply.github.com"

      - checkout
      - run: yarn install
      - run: yarn test

      - run:
          name: test if dependency commands are installed
          command: |
            hash git
            hash rsync
            hash yarn

      - deploy:
          command: |
            if [[ "${CIRCLE_BRANCH}" = "master" ]]; then
              ./.circleci/deploy.sh
            fi
